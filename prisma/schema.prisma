// ============================================
// PRISMA SCHEMA - Databázová schéma
// ============================================
//
// Tento súbor definuje všetky databázové modely pre WordForge
//
// Hlavné modely:
// 1. User - Používatelia (autentifikácia + profil)
// 2. Account - OAuth accounts (pre NextAuth)
// 3. Session - User sessions (pre NextAuth)
// 4. Game - Záznamy hier
// 5. Word - Slovníky (EN, CZ, SK)
// 6. Leaderboard - Rebríčky
// 7. UserStats - Používateľské štatistiky
//
// Po zmene schémy spusti:
// - npx prisma generate (generuje Prisma Client)
// - npx prisma db push (aplikuje zmeny do DB bez migrácií)
// ALEBO
// - npx prisma migrate dev --name nazov_zmeny (vytvori migráciu)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTH MODELS (NextAuth.js)
// ============================================
// Tieto modely sú potrebné pre NextAuth s Prisma Adapter
// Dokumentácia: https://authjs.dev/reference/adapter/prisma

model User {
  // = Základné NextAuth polia =
  id            String    @id @default(cuid())
  email         String?   @unique
  emailVerified DateTime?
  image         String?   // Avatar URL
  password      String? // password field for credentials login

  // = Custom polia pre WordForge =
  name      String?   @unique // Zobrazované meno na rebríčku
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // = Relácie =
  accounts      Account[]
  sessions      Session[]
  games         Game[]
  leaderboardEntries LeaderboardEntry[]
  stats         UserStats[]
}

model Account {
  // = NextAuth Account model =
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  // = NextAuth Session model =
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  // = NextAuth VerificationToken model =
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// GAME MODELS
// ============================================

model Game {
  // = Záznam jednej hry =
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  // = Herné nastavenia =
  mode          String  // "solo_classic" (neskôr "pvp", "coop", "challenge")
  scoringMode   String  // "tempo" alebo "length"
  visibilityMode String // "open" alebo "hidden"
  language      String  // "en", "cz", "sk"

  // = Časovače (v sekundách) =
  turnTimeLimit   Int  // Ťahový čas (napr. 7-10s)
  globalTimeLimit Int  // Globálny čas (napr. 180-300s)

  // = Výsledky =
  score         Int      // Finálne skóre
  wordCount     Int      // Počet slov
  longestWord   String?  // Najdlhšie slovo
  averageLength Float?   // Priemerná dĺžka slova
  wpm           Float?   // Words per minute
  accuracy      Float?   // Presnosť (úspešné / celkové pokusy)

  // = Zoznam použitých slov (JSON array) =
  // Uložené ako JSON: [{word: "apple", length: 5, points: 1}, ...]
  wordsUsed     Json

  // = Metadata =
  startedAt     DateTime @default(now())
  finishedAt    DateTime?

  // = Indexy pre rýchle dotazy =
  @@index([userId])
  @@index([mode, scoringMode, visibilityMode, language])
}

// ============================================
// WORD DICTIONARY MODELS
// ============================================

model Word {
  // = Slovník - slová pre validáciu =
  id       String @id @default(cuid())
  word     String // Slovo (lowercase, bez diakritiky pre rýchle porovnanie)
  language String // "en", "cz", "sk"
  length   Int    // Dĺžka slova (pre rýchle filtrovanie)

  // = Voliteľné =
  isVulgar Boolean @default(false) // Filter vulgarizmov

  // = Indexy pre rýchle vyhľadávanie =
  @@unique([word, language])
  @@index([language])
  @@index([language, length])
}

// ============================================
// LEADERBOARD MODELS
// ============================================

model LeaderboardEntry {
  // = Záznam na rebríčku =
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // = Kombinácia módu (určuje konkrétny rebríček) =
  mode           String // "solo_classic"
  scoringMode    String // "tempo" alebo "length"
  visibilityMode String // "open" alebo "hidden"
  language       String // "en", "cz", "sk"

  // = Skóre a dáta =
  score       Int
  wordCount   Int
  longestWord String?
  achievedAt  DateTime @default(now())

  // = Každý user môže mať len jeden záznam pre každú kombináciu =
  // Pri novom rekorde sa updatuje existujúci záznam
  @@unique([userId, mode, scoringMode, visibilityMode, language])
  @@index([mode, scoringMode, visibilityMode, language, score])
}

// ============================================
// STATISTICS MODELS
// ============================================

model UserStats {
  // = Štatistiky používateľa =
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // = Pre každý jazyk samostatné štatistiky =
  language String // "en", "cz", "sk"

  // = Štatistiky =
  totalGames       Int   @default(0)
  totalWords       Int   @default(0)
  totalScore       Int   @default(0)
  longestWord      String?
  longestWordLength Int  @default(0)
  averageWordLength Float @default(0)
  averageWpm       Float @default(0)
  averageAccuracy  Float @default(0)

  // = Updatované po každej hre =
  updatedAt DateTime @updatedAt

  @@unique([userId, language])
  @@index([userId])
}

// ============================================
// POZNÁMKY K DATABÁZE
// ============================================
//
// Seed Data:
// - Words tabuľka sa naplní cez seed script (prisma/seed.ts)
// - Načítať wordlisty z JSON/TXT súborov a vložiť do DB
//
// Migrácie:
// - Pre development: npx prisma db push
// - Pre production: npx prisma migrate deploy
//
// Prisma Studio (GUI pre databázu):
// - npx prisma studio
//
// Indexy:
// - Pridané indexy pre rýchle dotazy na rebríčky a vyhľadávanie slov
